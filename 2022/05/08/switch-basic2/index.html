<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>交换基础2-STP | Arclogic的博客</title>
  <meta name="description" content="STP，Spanning Tree Protocol，生成树协议。网络管理员经常会部署一些冗余链路防止单点中断，但是在一个交换网络中，冗余的链路可能引起重复帧甚至是广播风暴。为解决二层网络中交换节点之间的唯一路径问题，STP被设计出来解决二层环路。STP的目的是在二层冗余网络中在任意节点之间计算出一条最优无环路径。 STP主要有三个IEEE版本，802.1D&#x2F;802.1w&#x2F;80">
<meta property="og:type" content="article">
<meta property="og:title" content="交换基础2-STP">
<meta property="og:url" content="https://arclogicr.github.io/2022/05/08/switch-basic2/index.html">
<meta property="og:site_name" content="Arclogic&#39;s Blog">
<meta property="og:description" content="STP，Spanning Tree Protocol，生成树协议。网络管理员经常会部署一些冗余链路防止单点中断，但是在一个交换网络中，冗余的链路可能引起重复帧甚至是广播风暴。为解决二层网络中交换节点之间的唯一路径问题，STP被设计出来解决二层环路。STP的目的是在二层冗余网络中在任意节点之间计算出一条最优无环路径。 STP主要有三个IEEE版本，802.1D&#x2F;802.1w&#x2F;80">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/stp_config.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/stp_tcn.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/stp_loop.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/pvst+_config.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/rstp_stp.jpg">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/rstp_bpdu.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/rstp_topo.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/mst_port.png">
<meta property="og:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/mst_bpdu.png">
<meta property="article:published_time" content="2022-05-07T17:02:18.000Z">
<meta property="article:modified_time" content="2023-02-17T09:08:31.622Z">
<meta property="article:author" content="Arclogic">
<meta property="article:tag" content="network">
<meta property="article:tag" content="switching">
<meta property="article:tag" content="stp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://arclogicr.github.io/2022/05/08/switch-basic2/stp_config.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://arclogicr.github.io/2022/05/08/switch-basic2/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Arclogic&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/arclogicr" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Arclogic</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">网络工程师</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>记录工作和生活里一些在意的东西</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/16/openwrt-ts/" class="title">虚拟机部署OpenWrt外部无法访问问题</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-16T14:10:58.000Z" itemprop="datePublished">2023-01-16</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/14/openwrt-ply/" class="title">使用VirtualBox部署OpenWrt充当旁路由</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-14T13:17:08.000Z" itemprop="datePublished">2023-01-14</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91/">文档翻译</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/12/openwrt-fw1/" class="title">OpenWrt防火墙翻译</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-12T10:34:55.000Z" itemprop="datePublished">2023-01-12</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/04/kvmq1/" class="title">kvm如何禁止虚拟机之间通信</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-04T07:37:05.000Z" itemprop="datePublished">2023-01-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a>
              </p>
              <p class="item-title">
                <a href="/2022/12/09/pushgateway/" class="title">使用pushgateway监控需要上传文件的应用接口</a>
              </p>
              <p class="item-date">
                <time datetime="2022-12-09T15:10:18.000Z" itemprop="datePublished">2022-12-09</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91/">文档翻译</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/">网络基础</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2RS/">路由交换RS</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/bgp/" rel="tag">bgp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/firewall/" rel="tag">firewall</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monitor/" rel="tag">monitor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openwrt/" rel="tag">openwrt</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ospf/" rel="tag">ospf</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/" rel="tag">prometheus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pushgateway/" rel="tag">pushgateway</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/routing/" rel="tag">routing</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stp/" rel="tag">stp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/switching/" rel="tag">switching</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp-ip/" rel="tag">tcp&#x2F;ip</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translation/" rel="tag">translation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualbox/" rel="tag">virtualbox</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vlan/" rel="tag">vlan</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vtp/" rel="tag">vtp</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#IEEE-802-1D-STP"><span class="toc-number">1.</span> <span class="toc-text">IEEE 802.1D STP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#STP%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">STP相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E6%A1%A5Root-Bridge"><span class="toc-number">1.1.1.</span> <span class="toc-text">根桥Root Bridge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%A5ID-Bridge-ID"><span class="toc-number">1.1.2.</span> <span class="toc-text">桥ID Bridge ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3ID-Port-ID"><span class="toc-number">1.1.3.</span> <span class="toc-text">端口ID Port ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E8%B7%AF%E5%BE%84%E5%BC%80%E9%94%80RPC"><span class="toc-number">1.1.4.</span> <span class="toc-text">根路径开销RPC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STP%E7%AB%AF%E5%8F%A3%E8%A7%92%E8%89%B2"><span class="toc-number">1.2.</span> <span class="toc-text">STP端口角色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E7%AB%AF%E5%8F%A3RP"><span class="toc-number">1.2.1.</span> <span class="toc-text">根端口RP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3DP"><span class="toc-number">1.2.2.</span> <span class="toc-text">指定端口DP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STP%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.</span> <span class="toc-text">STP端口状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Forwarding%E2%80%93%E8%BD%AC%E5%8F%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">Forwarding–转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Learning%E2%80%93%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.3.2.</span> <span class="toc-text">Learning–学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#listening%E2%80%93%E7%9B%91%E5%90%AC"><span class="toc-number">1.3.3.</span> <span class="toc-text">listening–监听</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Blocking%E2%80%93%E9%98%BB%E5%A1%9E"><span class="toc-number">1.3.4.</span> <span class="toc-text">Blocking–阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Disabled%E2%80%93%E7%A6%81%E7%94%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text">Disabled–禁用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BPDU"><span class="toc-number">1.4.</span> <span class="toc-text">BPDU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BPDU%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">BPDU类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEBPDU"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">配置BPDU</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TCN"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">TCN</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STP%E4%B8%89%E4%B8%AA%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.5.</span> <span class="toc-text">STP三个定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Hellotime"><span class="toc-number">1.5.1.</span> <span class="toc-text">Hellotime</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Forward-Delay"><span class="toc-number">1.5.2.</span> <span class="toc-text">Forward Delay</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Max-Age"><span class="toc-number">1.5.3.</span> <span class="toc-text">Max Age</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STP%E7%AB%AF%E5%8F%A3%E9%80%89%E4%B8%BE"><span class="toc-number">1.6.</span> <span class="toc-text">STP端口选举</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%A0%B9%E6%A1%A5"><span class="toc-number">1.6.1.</span> <span class="toc-text">选根桥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E9%9D%9E%E6%A0%B9%E6%A1%A5%EF%BC%89%E9%80%89%E6%A0%B9%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.6.2.</span> <span class="toc-text">（非根桥）选根端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E6%AF%8F%E6%AE%B5%E9%93%BE%E8%B7%AF%EF%BC%89%E9%80%89%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.6.3.</span> <span class="toc-text">（每段链路）选指定端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E9%9D%9E%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.6.4.</span> <span class="toc-text">阻塞非指定端口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%B1%82%E6%94%B6%E6%95%9B"><span class="toc-number">1.7.</span> <span class="toc-text">二层收敛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#STP%E6%94%B6%E6%95%9B"><span class="toc-number">1.7.1.</span> <span class="toc-text">STP收敛</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#STP%E6%94%B6%E6%95%9B%E6%97%B6%E9%97%B4"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">STP收敛时间</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CAM%E8%A1%A8%E6%94%B6%E6%95%9B"><span class="toc-number">1.7.2.</span> <span class="toc-text">CAM表收敛</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PVST-x2F-PVST"><span class="toc-number">1.8.</span> <span class="toc-text">PVST&#x2F;PVST+</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PVST"><span class="toc-number">1.8.1.</span> <span class="toc-text">PVST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PVST-1"><span class="toc-number">1.8.2.</span> <span class="toc-text">PVST+</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PVST-%E7%9A%84BID"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">PVST+的BID</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PVST-%E5%A2%9E%E5%BC%BA%E7%89%B9%E6%80%A7"><span class="toc-number">1.8.3.</span> <span class="toc-text">PVST+增强特性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PortFast"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">PortFast</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UplinkFast"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">UplinkFast</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Backbonefast"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">Backbonefast</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IEEE-802-1w-Rapid-STP"><span class="toc-number">2.</span> <span class="toc-text">IEEE 802.1w Rapid STP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E9%93%BE%E8%B7%AF%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.</span> <span class="toc-text">RSTP链路类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Point-to-Point-Link"><span class="toc-number">2.1.1.</span> <span class="toc-text">Point-to-Point Link</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Shared-Link"><span class="toc-number">2.1.2.</span> <span class="toc-text">Shared Link</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Edge"><span class="toc-number">2.1.3.</span> <span class="toc-text">Edge</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E7%AB%AF%E5%8F%A3%E8%A7%92%E8%89%B2"><span class="toc-number">2.2.</span> <span class="toc-text">RSTP端口角色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%BF%E4%BB%A3%E7%AB%AF%E5%8F%A3AP"><span class="toc-number">2.2.1.</span> <span class="toc-text">替代端口AP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E7%AB%AF%E5%8F%A3BP"><span class="toc-number">2.2.2.</span> <span class="toc-text">备份端口BP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%B9%E7%BC%98%E7%AB%AF%E5%8F%A3EP"><span class="toc-number">2.2.3.</span> <span class="toc-text">边缘端口EP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81"><span class="toc-number">2.3.</span> <span class="toc-text">RSTP端口状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Forwarding%E2%80%93%E8%BD%AC%E5%8F%91-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">Forwarding–转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Learning%E2%80%93%E5%AD%A6%E4%B9%A0-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">Learning–学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Discarding%E2%80%93%E4%B8%A2%E5%BC%83"><span class="toc-number">2.3.3.</span> <span class="toc-text">Discarding–丢弃</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81%E4%B8%8ESTP%E5%AF%B9%E6%AF%94"><span class="toc-number">2.3.4.</span> <span class="toc-text">RSTP端口状态与STP对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP-BPDU%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.</span> <span class="toc-text">RSTP BPDU报文结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E7%AB%AF%E5%8F%A3%E9%80%89%E4%B8%BE"><span class="toc-number">2.5.</span> <span class="toc-text">RSTP端口选举</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP%E7%AB%AF%E5%8F%A3%E9%80%89%E4%B8%BE%E4%B8%BE%E4%BE%8B"><span class="toc-number">2.5.1.</span> <span class="toc-text">RSTP端口选举举例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E6%94%B6%E6%95%9B"><span class="toc-number">2.6.</span> <span class="toc-text">RSTP收敛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP%E5%AF%B9BPDU%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">2.6.1.</span> <span class="toc-text">RSTP对BPDU的处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP%E6%8B%93%E6%89%91%E5%8F%98%E6%9B%B4"><span class="toc-number">2.6.2.</span> <span class="toc-text">RSTP拓扑变更</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP-P-x2F-A%E5%8D%8F%E5%95%86%E6%9C%BA%E5%88%B6"><span class="toc-number">2.6.3.</span> <span class="toc-text">RSTP P&#x2F;A协商机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP%E6%94%B6%E6%95%9B%E6%97%B6%E9%97%B4%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93"><span class="toc-number">2.6.4.</span> <span class="toc-text">RSTP收敛时间优化总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%8A%9F%E8%83%BD"><span class="toc-number">2.7.</span> <span class="toc-text">RSTP安全防护功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BPDU-GUARD"><span class="toc-number">2.7.1.</span> <span class="toc-text">BPDU GUARD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BPDU-FILTER"><span class="toc-number">2.7.2.</span> <span class="toc-text">BPDU FILTER</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GUARD-ROOT"><span class="toc-number">2.7.3.</span> <span class="toc-text">GUARD ROOT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GUARD-LOOP"><span class="toc-number">2.7.4.</span> <span class="toc-text">GUARD LOOP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RSTP%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.5.</span> <span class="toc-text">RSTP安全防护相关配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSTP%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">2.8.</span> <span class="toc-text">RSTP兼容性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rapid-PVST"><span class="toc-number">2.8.1.</span> <span class="toc-text">Rapid-PVST+</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IEEE802-1s-MST"><span class="toc-number">3.</span> <span class="toc-text">IEEE802.1s MST</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="toc-number">3.1.</span> <span class="toc-text">MST的改进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIST"><span class="toc-number">3.2.</span> <span class="toc-text">MIST</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">3.3.</span> <span class="toc-text">MST相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MST-Region"><span class="toc-number">3.3.1.</span> <span class="toc-text">MST Region</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSTI"><span class="toc-number">3.3.2.</span> <span class="toc-text">MSTI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CST"><span class="toc-number">3.3.3.</span> <span class="toc-text">CST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IST"><span class="toc-number">3.3.4.</span> <span class="toc-text">IST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CIST"><span class="toc-number">3.3.5.</span> <span class="toc-text">CIST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E6%A0%B9"><span class="toc-number">3.3.6.</span> <span class="toc-text">域根</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E6%A0%B9"><span class="toc-number">3.3.7.</span> <span class="toc-text">总根</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E7%AB%AF%E5%8F%A3%E8%A7%92%E8%89%B2"><span class="toc-number">3.4.</span> <span class="toc-text">MST端口角色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Master%E7%AB%AF%E5%8F%A3MP"><span class="toc-number">3.4.1.</span> <span class="toc-text">Master端口MP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E8%BE%B9%E7%BC%98%E7%AB%AF%E5%8F%A3BdP"><span class="toc-number">3.4.2.</span> <span class="toc-text">域边缘端口BdP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81"><span class="toc-number">3.5.</span> <span class="toc-text">MST端口状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST-BPDU%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.6.</span> <span class="toc-text">MST BPDU格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E6%94%B6%E6%95%9B"><span class="toc-number">3.7.</span> <span class="toc-text">MST收敛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CIST%E6%8B%93%E6%89%91%E8%AE%A1%E7%AE%97"><span class="toc-number">3.7.1.</span> <span class="toc-text">CIST拓扑计算</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CIST%E6%80%BB%E6%A0%B9%E9%80%89%E4%B8%BE"><span class="toc-number">3.7.1.1.</span> <span class="toc-text">CIST总根选举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CIST%E7%AB%AF%E5%8F%A3%E8%A7%92%E8%89%B2%E9%80%89%E4%B8%BE%EF%BC%88RP-x2F-DP-x2F-MP%EF%BC%89"><span class="toc-number">3.7.1.2.</span> <span class="toc-text">CIST端口角色选举（RP&#x2F;DP&#x2F;MP）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSTI%E6%8B%93%E6%89%91%E8%AE%A1%E7%AE%97"><span class="toc-number">3.7.2.</span> <span class="toc-text">MSTI拓扑计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MST%E6%8B%93%E6%89%91%E5%8F%98%E5%8C%96%E4%B8%8E%E5%BF%AB%E9%80%9F%E6%94%B6%E6%95%9B%E6%9C%BA%E5%88%B6"><span class="toc-number">3.7.3.</span> <span class="toc-text">MST拓扑变化与快速收敛机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">3.8.</span> <span class="toc-text">MST兼容性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MST%E9%85%8D%E7%BD%AE"><span class="toc-number">3.9.</span> <span class="toc-text">MST配置</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-switch-basic2" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      交换基础2-STP
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/05/08/switch-basic2/" class="article-date">
	  <time datetime="2022-05-07T17:02:18.000Z" itemprop="datePublished">2022-05-08</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2RS/">路由交换RS</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/network/" rel="tag">network</a>, <a class="article-tag-link-link" href="/tags/stp/" rel="tag">stp</a>, <a class="article-tag-link-link" href="/tags/switching/" rel="tag">switching</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/05/08/switch-basic2/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>STP，Spanning Tree Protocol，生成树协议。网络管理员经常会部署一些冗余链路防止单点中断，但是在一个交换网络中，冗余的链路可能引起重复帧甚至是广播风暴。为解决二层网络中交换节点之间的唯一路径问题，STP被设计出来解决二层环路。STP的目的是在二层冗余网络中在任意节点之间计算出一条最优无环路径。</p>
<p>STP主要有三个IEEE版本，802.1D&#x2F;802.1w&#x2F;802.1s。广义的STP泛指所有STP相关协议，如IEEE定义的上述三个标准，以及各厂商私有PVST&#x2F;PVST， RAPID-PVST+，VBST等；狭义的STP专指IEEE802.1D STP。</p>
<h2 id="IEEE-802-1D-STP"><a href="#IEEE-802-1D-STP" class="headerlink" title="IEEE 802.1D STP"></a>IEEE 802.1D STP</h2><p>IEEE802.1D是STP最早的版本。STP采用STA(Spanning Tree Arithmetic)算法，在冗余链路中选择一个参考点（根桥），将选择要到达的路径，并阻断其它路径。若路径失效，自动启用其它路径。</p>
<h3 id="STP相关概念"><a href="#STP相关概念" class="headerlink" title="STP相关概念"></a>STP相关概念</h3><h4 id="根桥Root-Bridge"><a href="#根桥Root-Bridge" class="headerlink" title="根桥Root Bridge"></a>根桥Root Bridge</h4><p>STA算法选定的参考点，是整个二层网络的逻辑中心。根桥可能会伴随网络拓扑变化而发生改变，但通常在二层网络设计中，会令根桥固定为某台核心交换机。</p>
<h4 id="桥ID-Bridge-ID"><a href="#桥ID-Bridge-ID" class="headerlink" title="桥ID Bridge ID"></a>桥ID Bridge ID</h4><p>交换机为STP分配的唯一标识号，不同版本STP有不同的结构。IEEE802.1D标准定义BID由2字节优先级（0-65535）和6个字节基mac共8字节组成。其中思科设备交换机默认优先级32768，可以手动修改，PVST+&#x2F;Rapid PVST+优先级配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree vlan 3-5 priority</span><br></pre></td></tr></table></figure>

<h4 id="端口ID-Port-ID"><a href="#端口ID-Port-ID" class="headerlink" title="端口ID Port ID"></a>端口ID Port ID</h4><p>端口ID是发送BPDU端口的标识符，由4bit端口优先级和12bit端口号共16bit组成。PID通常被用来选举指定端口</p>
<h4 id="根路径开销RPC"><a href="#根路径开销RPC" class="headerlink" title="根路径开销RPC"></a>根路径开销RPC</h4><p>根路径开销是非根桥到根桥的最短路径开销，根端口的根路径开销都位0。路径开销是STP协议用于选择链路的参考值。根桥发出的COST值是0，在下一交换机的入口处才加上COST值，出口处COST值不变。某段链路的路径开销具体参考取值如下：</p>
<table>
<thead>
<tr>
<th>数据速率</th>
<th>802.1D STP</th>
<th>32bit推荐值(RSTP&#x2F;MSTP)</th>
</tr>
</thead>
<tbody><tr>
<td>10Mbps</td>
<td>100</td>
<td>2000000</td>
</tr>
<tr>
<td>100Mbps</td>
<td>19</td>
<td>200000</td>
</tr>
<tr>
<td>1Gbps</td>
<td>4</td>
<td>20000</td>
</tr>
<tr>
<td>10Gbps</td>
<td>2</td>
<td>2000</td>
</tr>
</tbody></table>
<h3 id="STP端口角色"><a href="#STP端口角色" class="headerlink" title="STP端口角色"></a>STP端口角色</h3><h4 id="根端口RP"><a href="#根端口RP" class="headerlink" title="根端口RP"></a>根端口RP</h4><p>根端口是去往根桥开销最小的端口。根端口负责向根桥方向转发数据，并接收上游BPDU和数据流量。每个交换机只有一个根端口，根桥没有根端口。</p>
<h4 id="指定端口DP"><a href="#指定端口DP" class="headerlink" title="指定端口DP"></a>指定端口DP</h4><p>指定端口是一台交换机向下游交换机转发BPDU的端口。在二层网络每一段都会选举一个指定端口。</p>
<h3 id="STP端口状态"><a href="#STP端口状态" class="headerlink" title="STP端口状态"></a>STP端口状态</h3><h4 id="Forwarding–转发"><a href="#Forwarding–转发" class="headerlink" title="Forwarding–转发"></a>Forwarding–转发</h4><p>转发状态下的端口既转发用户流量，也处理BPDU。转发状态是端口正常转发的最终状态。</p>
<h4 id="Learning–学习"><a href="#Learning–学习" class="headerlink" title="Learning–学习"></a>Learning–学习</h4><p>学习状态下的端口根据用户流量学习建立CAM表，但不转发流量。学习状态是为了防止临时环路的过渡状态。此过程持续15s。</p>
<h4 id="listening–监听"><a href="#listening–监听" class="headerlink" title="listening–监听"></a>listening–监听</h4><p>监听状态下的端口确定端口角色，选举根桥、RP和DP。此过程持续15s。</p>
<h4 id="Blocking–阻塞"><a href="#Blocking–阻塞" class="headerlink" title="Blocking–阻塞"></a>Blocking–阻塞</h4><p>阻塞状态下的端口仅接受并处理BPDU，不转发用户数据。阻塞状态是STP收敛后阻塞端口的最终状态。</p>
<h4 id="Disabled–禁用"><a href="#Disabled–禁用" class="headerlink" title="Disabled–禁用"></a>Disabled–禁用</h4><p>端口down，或未开启STP</p>
<h3 id="BPDU"><a href="#BPDU" class="headerlink" title="BPDU"></a>BPDU</h3><p>BPDU，Bridge Protocol Data Unit，桥协议数据单元，是STP协议通信的报文。BPDU直接采用二层封装，有以下作用：</p>
<ul>
<li><p>选举根桥</p>
</li>
<li><p>确定冗余路径未知</p>
</li>
<li><p>阻塞端口</p>
</li>
<li><p>通告拓扑变更</p>
</li>
<li><p>监控STP状态</p>
</li>
</ul>
<p>初始状态下，二层网络每台交换机都认为自己是根桥，每隔2s发送BPDU，直到根桥被选举后，只有根桥会发送BPDU。非根桥只能进行转发。</p>
<h4 id="BPDU类型"><a href="#BPDU类型" class="headerlink" title="BPDU类型"></a>BPDU类型</h4><h5 id="配置BPDU"><a href="#配置BPDU" class="headerlink" title="配置BPDU"></a>配置BPDU</h5><p>通常由根桥周期性发出包括STP参数用于各种角色选举。802.1D配置BPDU抓包如下：</p>
<p><img src="/2022/05/08/switch-basic2/stp_config.png" alt="SWITCH STP_CONFIG"></p>
<p>配置BPDU包含以下字段</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Protocol ID</td>
<td>STP固定为0</td>
</tr>
<tr>
<td>Version</td>
<td>协议版本，STP为0，RSTP为2，MSTP为3</td>
</tr>
<tr>
<td>Message Type</td>
<td>BPDU类型，标记不同协议的conf或tcn BPDU</td>
</tr>
<tr>
<td>Flags</td>
<td>标记TC或TCA</td>
</tr>
<tr>
<td>Root ID</td>
<td>根ID</td>
</tr>
<tr>
<td>Cost of Path</td>
<td>根路径开销</td>
</tr>
<tr>
<td>Bridge ID</td>
<td>发送者桥ID</td>
</tr>
<tr>
<td>Port ID</td>
<td>发送端口PID</td>
</tr>
<tr>
<td>Message age</td>
<td>该BPDU老化时间</td>
</tr>
<tr>
<td>Max age</td>
<td>最大老化时间</td>
</tr>
<tr>
<td>Hellotime</td>
<td>发送BPDU间隔时间</td>
</tr>
<tr>
<td>Forward delay</td>
<td>控制listening和learning状态的持续时间</td>
</tr>
</tbody></table>
<h5 id="TCN"><a href="#TCN" class="headerlink" title="TCN"></a>TCN</h5><p>拓扑变化通告，当交换机检测到拓扑变化时发出。TCN BPDU只包含Protocol ID，Version和Message Type三个字段。802.1DTCN BPDU抓包如下：</p>
<p><img src="/2022/05/08/switch-basic2/stp_tcn.png" alt="SWITCH STP_TCN"></p>
<h3 id="STP三个定时器"><a href="#STP三个定时器" class="headerlink" title="STP三个定时器"></a>STP三个定时器</h3><h4 id="Hellotime"><a href="#Hellotime" class="headerlink" title="Hellotime"></a>Hellotime</h4><p>hellotime用于指定根桥连续发送BPDU的间隔，<u>默认值2秒</u>。</p>
<h4 id="Forward-Delay"><a href="#Forward-Delay" class="headerlink" title="Forward Delay"></a>Forward Delay</h4><p>转发延迟用于指定在Listening和Learning状态下所停留的时间，<u>默认值15秒</u>。</p>
<h4 id="Max-Age"><a href="#Max-Age" class="headerlink" title="Max Age"></a>Max Age</h4><p>最大存活时间，<u>默认值20秒</u>。此时间内没有收到BPDU，则不再承认老根桥。</p>
<p>PVST+&#x2F;Rapid PVST+定时器配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch(config)#spanning-tree vlan 3-5 [forward-time/hello-time/max-age]</span><br></pre></td></tr></table></figure>

<h3 id="STP端口选举"><a href="#STP端口选举" class="headerlink" title="STP端口选举"></a>STP端口选举</h3><p>初始状态下，每台交换机认为自己是根桥，每2s扩散配置BPDU。STP通过一系列的选举，决定根桥、根端口、指定端口和非指定端口。<strong>在STP的各种选举中，参数值越小越优</strong>。</p>
<p>总结下来可用四句话概括：</p>
<p>One root bridge per network–选根桥<br>One root port per nonroot bridge-选根端口<br>One designated port per segment-每段链路选指定端口<br>Nondesignated ports are blocked-非指定端口被阻塞</p>
<h4 id="选根桥"><a href="#选根桥" class="headerlink" title="选根桥"></a>选根桥</h4><p>BID是STP为每台交换机分配的唯一标识符，STP使用IEEE802.1D定义的优先级+基mac组成的BID。每个网络中只有一个根桥，规定<u>拥有最小桥ID的交换机被选举为根桥</u>。</p>
<h4 id="（非根桥）选根端口"><a href="#（非根桥）选根端口" class="headerlink" title="（非根桥）选根端口"></a>（非根桥）选根端口</h4><p>每个非根桥有且只有一个根端口。对于非根桥，使用以下方法选举根端口：</p>
<p>1、该端口到达根桥cost最小</p>
<p>2、该端口收到的BID最小</p>
<p>3、该端口对接的端口PID最小，若对方PID相同则比较自己PID</p>
<h4 id="（每段链路）选指定端口"><a href="#（每段链路）选指定端口" class="headerlink" title="（每段链路）选指定端口"></a>（每段链路）选指定端口</h4><p>根桥所有端口都是指定端口。对于每段链路，使用以下方法选举指定端口：</p>
<p>1、到达根桥cost最小</p>
<p>2、BID最小的一端</p>
<p>3、（集线器共享链路，一个冲突域）对方端口PID最小，若对方PID相同则比较自己PID</p>
<h4 id="阻塞非指定端口"><a href="#阻塞非指定端口" class="headerlink" title="阻塞非指定端口"></a>阻塞非指定端口</h4><p>最后，既不是根端口，又不是指定端口的哪些接口被称为非指定端口，这些端口将被block掉。从而达到防环的目的。</p>
<p>在所有端口选举完成后，STP完成收敛，此时任意两节点之间的二层通路只有唯一一条。</p>
<h3 id="二层收敛"><a href="#二层收敛" class="headerlink" title="二层收敛"></a>二层收敛</h3><h4 id="STP收敛"><a href="#STP收敛" class="headerlink" title="STP收敛"></a>STP收敛</h4><p>当二层网络出现变动或故障时，可能会导致STP重收敛。STP会将端口状态按照以下顺序转变：BLOCKING–LISTENING–LEARNING–FORWARDING</p>
<h5 id="STP收敛时间"><a href="#STP收敛时间" class="headerlink" title="STP收敛时间"></a>STP收敛时间</h5><p>当拓扑发生变化时，端口从阻塞状态过渡到正常转发状态的时间是30-50S<br>如果是直连接口down掉，端口状态过渡最大需要30S，因为无需等老化<br>如果是非直连故障，最大需要50S</p>
<h4 id="CAM表收敛"><a href="#CAM表收敛" class="headerlink" title="CAM表收敛"></a>CAM表收敛</h4><p>二层网络故障或变动还会导致CAM表收敛。以下事件会使得STP发送TCN BPDU</p>
<ul>
<li><p>链路故障（FWD-BLK）</p>
</li>
<li><p>端口进入FWD状态，且交换机拥有DP</p>
</li>
<li><p>非根桥从DP收到TCN会将其转发</p>
</li>
</ul>
<p>CAM表收敛过程如下：</p>
<p>1、拓扑发生改变的交换机向RP端口发出TCN BPDU<br> 2、上级交换机做两件事：先回应一个TCA BPDU，再继续向自已的RP接口发出TCN的BPDU<br> 3、TCN的BPDU就这样一跳跳的传到根交换机上<br> 4、然后根交换机将自已MAC地址表的老化时间由默认的300S改为转发延迟时间(15S)。<br> 5、根交换机再向网络中发出TC置位的BPDU<br> 6、网络中的其他交换机收到TC置位的BPDU后，也将自已MAC地址表的老化时间由默认的300S改为15S。</p>
<p>这样，每台交换机就快速的老化了MAC地址表，清除掉了已经失效的MAC地址条目。</p>
<h3 id="PVST-x2F-PVST"><a href="#PVST-x2F-PVST" class="headerlink" title="PVST&#x2F;PVST+"></a>PVST&#x2F;PVST+</h3><p>很容易发现STP的一个弊端：STP协议将整个二层网络生成一颗树，这样就会导致诸多问题。比如不同VLAN可能会产生次优路径，冗余链路带宽浪费等。如下图所示，STP收敛后，阻塞一条链路，则在这条链路上任何VLAN的用户流量都不能被转发。</p>
<p><img src="/2022/05/08/switch-basic2/stp_loop.png" alt="SWITCH STP_LOOP"></p>
<h4 id="PVST"><a href="#PVST" class="headerlink" title="PVST"></a>PVST</h4><p>思科为解决上述问题，开发了PVST，Per Vlan STP。PVST为每个VLAN创建一颗生成树，解决了不同VLAN次优路径问题，另外可以通过设计将二层流量进行一定程度的负载分担。假设上图中描述了VLAN10的树，而VLAN20的树中被阻塞的是左边一条链路，那么在二层网络通信中，VLAN10和VLAN20的流量将分别走左右两条链路，利用了冗余链路的带宽。</p>
<h4 id="PVST-1"><a href="#PVST-1" class="headerlink" title="PVST+"></a>PVST+</h4><p>由于PVST只支持ISL封装，并且无法与IEEE802.1D STP兼容，思科很快又开发了增强的PVST+协议。PVST+支持dot1Q封装，并且在VLAN1内可以与IEEE802.1D STP对接。PVST可以通过PVST+与IEEE802.1D STP间接对接。思科设备默认运行PVST+生成树协议，PVST+在某个VLAN内运行时基本与STP类似，包括计时器、端口状态等。PVST+ BPDU有单独的目的mac地址0100-0ccc-cccd。</p>
<p>PVST+配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch(config)#spanning-tree mode pvst</span><br></pre></td></tr></table></figure>

<h5 id="PVST-的BID"><a href="#PVST-的BID" class="headerlink" title="PVST+的BID"></a>PVST+的BID</h5><p>PVST+在计算BID时与STP稍有不同。BID共8个字节，STP使用前2个字节做priority，后6个字节做mac地址，中间10bit，保留不用；PVST+后6个字节做mac地址，前2个字节前4bit用作priority，后12bit用于表示vlan号。比如，PVST+ BID前2个字节如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0011 0000 0000 000a</span><br></pre></td></tr></table></figure>

<p>则表示VLAN 10 的 优先级为12288（2^12+2^13），<u>由于只用高4bit表示优先级，这也是优先级只能表示为4096倍数的原因</u>。</p>
<p>PVST+配置BPDU抓包如下：</p>
<p><img src="/2022/05/08/switch-basic2/pvst+_config.png" alt="SWITCH PVST+_CONFIG"></p>
<h4 id="PVST-增强特性"><a href="#PVST-增强特性" class="headerlink" title="PVST+增强特性"></a>PVST+增强特性</h4><p>802.1D STP设计目的是为了让二层网络可以在冗余链路中断后，1min内恢复。这对于当时也不是一个很短的时间。为了加快收敛，Cisco设备支持了一些私有特性，优化STP收敛速度。</p>
<h5 id="PortFast"><a href="#PortFast" class="headerlink" title="PortFast"></a>PortFast</h5><p>PortFast特性可以让2层的接入端口跳过LIST&#x2F;LRN状态直接进入FWD，可以节省30s的收敛时间。PortFast通常配置在终端接入端口。Porfast配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#接口开启</span><br><span class="line">switch(config-if)#spanning-tree portfast</span><br><span class="line"></span><br><span class="line">#或全局开启</span><br><span class="line">switch(config)#spanning-tree portfast edge default</span><br></pre></td></tr></table></figure>

<h5 id="UplinkFast"><a href="#UplinkFast" class="headerlink" title="UplinkFast"></a>UplinkFast</h5><p>UplinkFast特性用于检测直连到汇聚层链路故障并加快收敛。当上联FWD链路中断时，UplinkFast将增加交换机STP的priority和cost，原有BLK链路立即转为FWD状态，可节省30s时间。UplinkFast是全局命令，影响所有VLAN。UplinkFast配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch(config)#spanning-tree uplinkfast</span><br></pre></td></tr></table></figure>

<h5 id="Backbonefast"><a href="#Backbonefast" class="headerlink" title="Backbonefast"></a>Backbonefast</h5><p>Backbonefast特性是用于检测主干SW间的链路故障。接受到次级BPDU后会主动发送RLQ BPDU探测链路，加速收敛，可以节省20s老化时间。BackboneFast需要在所有交换机配置，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch(config)#spanning-tree backbonefast</span><br></pre></td></tr></table></figure>

<h2 id="IEEE-802-1w-Rapid-STP"><a href="#IEEE-802-1w-Rapid-STP" class="headerlink" title="IEEE 802.1w Rapid STP"></a>IEEE 802.1w Rapid STP</h2><p>IEEE802.1w在IEEE802.1D基础上改进了STP，制定了RSTP，快速生成树协议，RSTP加快了收敛速度并增加边缘端口及STP防护功能。</p>
<h3 id="RSTP链路类型"><a href="#RSTP链路类型" class="headerlink" title="RSTP链路类型"></a>RSTP链路类型</h3><p>运行RSTP的端口加入了链路类型概念。</p>
<h4 id="Point-to-Point-Link"><a href="#Point-to-Point-Link" class="headerlink" title="Point-to-Point Link"></a>Point-to-Point Link</h4><p>点对点链路一般用于点对点连接的全双工链路，只有在点对点链路下，RSTP才能实现快速收敛。</p>
<h4 id="Shared-Link"><a href="#Shared-Link" class="headerlink" title="Shared Link"></a>Shared Link</h4><p>共享链路用于连接物理层HUB的链路。</p>
<h4 id="Edge"><a href="#Edge" class="headerlink" title="Edge"></a>Edge</h4><p>边缘链路，用于接入终端设备。</p>
<p>RSTP链路类型配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch(config-if)#spanning-tree link-type [point-to-point/shared]</span><br></pre></td></tr></table></figure>

<h3 id="RSTP端口角色"><a href="#RSTP端口角色" class="headerlink" title="RSTP端口角色"></a>RSTP端口角色</h3><p>RSTP保留了STP中的<strong>根端口RP</strong>和<strong>指定端口DP</strong>的概念</p>
<h4 id="替代端口AP"><a href="#替代端口AP" class="headerlink" title="替代端口AP"></a>替代端口AP</h4><p>到根网桥的替换路径, 用以替换的根端口, 责任是为其他网桥的链路作备份</p>
<h4 id="备份端口BP"><a href="#备份端口BP" class="headerlink" title="备份端口BP"></a>备份端口BP</h4><p>是指定端口的备份端口, 是为本网桥的端口作备份。备份端口只有两种情况下会存在：</p>
<ul>
<li><p>同一交换机两个端口通过点到点链路相连成一个环路</p>
</li>
<li><p>网桥与物理层HUB共享网络有多条连接</p>
</li>
</ul>
<h4 id="边缘端口EP"><a href="#边缘端口EP" class="headerlink" title="边缘端口EP"></a>边缘端口EP</h4><p>边缘端口, 指网桥上连接到终端设备的端口, 此类端口可以实现快速收敛。边缘端口和PVST+的portfast类似，在up&#x2F;down后不会产生拓扑改变。但是当RSTP边缘端口收到BPDU后，该端口会变成一个正常的生成树端口。</p>
<h3 id="RSTP端口状态"><a href="#RSTP端口状态" class="headerlink" title="RSTP端口状态"></a>RSTP端口状态</h3><h4 id="Forwarding–转发-1"><a href="#Forwarding–转发-1" class="headerlink" title="Forwarding–转发"></a>Forwarding–转发</h4><p>转发状态下的端口既转发用户流量，也处理BPDU。转发状态是端口正常转发的最终状态。</p>
<h4 id="Learning–学习-1"><a href="#Learning–学习-1" class="headerlink" title="Learning–学习"></a>Learning–学习</h4><p>学习状态下的端口根据用户流量学习建立CAM表，但不转发流量。学习状态是为了防止临时环路的过渡状态。此过程持续15s。</p>
<h4 id="Discarding–丢弃"><a href="#Discarding–丢弃" class="headerlink" title="Discarding–丢弃"></a>Discarding–丢弃</h4><p>丢弃状态下的端口仅接受并处理BPDU，不转发用户数据。阻塞状态是STP收敛后阻塞端口的最终状态。</p>
<h4 id="RSTP端口状态与STP对比"><a href="#RSTP端口状态与STP对比" class="headerlink" title="RSTP端口状态与STP对比"></a>RSTP端口状态与STP对比</h4><table>
<thead>
<tr>
<th>802.1D STP</th>
<th>802.1w RSTP</th>
<th>学习mac</th>
<th>收发用户数据</th>
</tr>
</thead>
<tbody><tr>
<td>Disabled</td>
<td>Discarding</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>Blocking</td>
<td>Discarding</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>Listening</td>
<td>Discarding</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>Learning</td>
<td>Learning</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>Forwarding</td>
<td>Forwarding</td>
<td>是</td>
<td>是</td>
</tr>
</tbody></table>
<h3 id="RSTP-BPDU报文结构"><a href="#RSTP-BPDU报文结构" class="headerlink" title="RSTP BPDU报文结构"></a>RSTP BPDU报文结构</h3><p>RSTP与STP采用相同的目的mac地址0180-c200-0000。有以下字段与STP不同</p>
<p><img src="/2022/05/08/switch-basic2/rstp_stp.jpg" alt="SWITCH RSTP_STP"></p>
<p>其中</p>
<p>version字段，message字段有改变，改为RSTP对应的值。</p>
<p>flag字段全部被使用，用于协商加速收敛。</p>
<p>增加v1长度字段</p>
<p>RSTP抓包如下：</p>
<p><img src="/2022/05/08/switch-basic2/rstp_bpdu.png" alt="SWITCH RSTP_BPDU"></p>
<p>除非有老设备，否则通常RSTP不需要TCN BPDUP，RSTP使用TC置位的config BPDU通知拓扑变化</p>
<h3 id="RSTP端口选举"><a href="#RSTP端口选举" class="headerlink" title="RSTP端口选举"></a>RSTP端口选举</h3><p>RSTP与STP不同，在任何时候都会每隔2s发送BPDU。初始状态下，各交换机通过BPDU选举各式端口角色。</p>
<p>RSTP的根桥、RP、DP选举与STP类似，RSTP增加了AP和BP端口的选举。规则如下：</p>
<ul>
<li><p>BP是DP的备份，所以某段链路选举出DP后，该DP所在交换机为指定交换机，BP只能出现在指定交换机上。</p>
</li>
<li><p>AP是RP的备份，除了DP,RP,BP，剩下的端口就是AP</p>
</li>
</ul>
<p>RSTP工作选举顺序可以总结为如下：</p>
<p>1、选根桥RB（与STP方法类似）</p>
<p>2、选根端口RP（与STP方法类似）</p>
<p>3、选指定端口DP（与STP方法类似）</p>
<p>4、选备份端口BP</p>
<p>5、剩余的是替代端口AP</p>
<p>6、AP和BP进入Discarding状态</p>
<h4 id="RSTP端口选举举例"><a href="#RSTP端口选举举例" class="headerlink" title="RSTP端口选举举例"></a>RSTP端口选举举例</h4><p>假设BID SW1&lt;SW2&lt;SW3，除了右边3号端口所在链路cost为3，其余每条链路的cost为1，图中数字代表端口号。最下面的HUB不运行STP。</p>
<p><img src="/2022/05/08/switch-basic2/rstp_topo.png" alt="SWITCH RSTP_TOPO"></p>
<p>可以根据上述规则，按照以下步骤分析：</p>
<p>1、选根桥，SW1 BID最小，成为根桥；</p>
<p>2、选根端口，SW2&#x2F;SW3上联口到根桥SW1的cost都是1，毫无疑问是RP。SW4上联cost是3，9&#x2F;10端口是2&lt;3，又因为9号端口号小，所以9号端口是RP。这里SW4到SW3虽有两条线路，但对于STP来说中间设备是透明的（不运行STP），视作一条链路；</p>
<p>3、选指定端口，首先根桥1，2，3端口都是DP；然后SW2&#x2F;SW3&#x2F;SW4通过HUB连接，相当于在一个段中，所以45678910中只会选举一个DP，由于SW2 BID最小，所以选择PID最小的4号端口作为DP；</p>
<p>4、选备份端口，由于DP在SW2上，所以同一段的5、6两个端口为BP；</p>
<p>5、其余的端口为AP</p>
<h3 id="RSTP收敛"><a href="#RSTP收敛" class="headerlink" title="RSTP收敛"></a>RSTP收敛</h3><h4 id="RSTP对BPDU的处理"><a href="#RSTP对BPDU的处理" class="headerlink" title="RSTP对BPDU的处理"></a>RSTP对BPDU的处理</h4><ul>
<li><p>与STP不同，任何时候RSTP每隔2s就会发送BPDU。</p>
</li>
<li><p>STP中，老化必须等待20s；RSTP中当一台交换机3个hellotime没收到BPDU就会老化自己的BPDU配置信息；这种老化机制可以快速检测故障。</p>
</li>
<li><p>STP的DP收到次级BPDU会把更优的BPDU发出去，对非指定端口不会做同样处理；RSTP中无论是否为DP，收到次级BPDU都会马上发送本地更优的BPDU给对方，或覆盖现有BPDU信息。</p>
</li>
</ul>
<h4 id="RSTP拓扑变更"><a href="#RSTP拓扑变更" class="headerlink" title="RSTP拓扑变更"></a>RSTP拓扑变更</h4><p><strong><u>在RSTP中，只有非边缘端口进入FWD状态时，才能导致拓扑改变。</u></strong></p>
<p>当某台交换机检测到拓扑改变后，进行以下操作：</p>
<ul>
<li><p>为所有非edge DP和RP启动计时器，为2倍hellotime</p>
</li>
<li><p>清空这些端口的mac地址</p>
</li>
<li><p>计时器有效期内，向这些端口发送TC置位的BPDU</p>
</li>
</ul>
<p>其它交换机收到TC置位的BPDU后，进行以下操作：</p>
<ul>
<li><p>清除接受TC端口以外所有端口的mac地址</p>
</li>
<li><p>所有端口启动2倍hellotime计时器，并在时间内发送TC置位BPDU。</p>
</li>
</ul>
<h4 id="RSTP-P-x2F-A协商机制"><a href="#RSTP-P-x2F-A协商机制" class="headerlink" title="RSTP P&#x2F;A协商机制"></a>RSTP P&#x2F;A协商机制</h4><p>P&#x2F;A，Proposal&#x2F;Agreement机制用于主动协商RP、DP，P&#x2F;A机制仅在p2p链路上生效。当指定端口DP处于Learning或Discarding状态时，此时需要将proposal置位。P&#x2F;A协商过程：</p>
<p>1、SW1发送P置位的BPDU</p>
<p>2、阻塞所有端口（除边缘端口）</p>
<p>3、SW2根据自身情况，回复A置位的BPDU</p>
<p>4、SW1收到A置位的BPDU后，该端口立即进入FWD</p>
<h4 id="RSTP收敛时间优化总结"><a href="#RSTP收敛时间优化总结" class="headerlink" title="RSTP收敛时间优化总结"></a>RSTP收敛时间优化总结</h4><ul>
<li><p>直连故障，可以用过AP&#x2F;BP立即进入FWD状态</p>
</li>
<li><p>P&#x2F;A协商，可以使RP和DP互联口立即进入FWD</p>
</li>
<li><p>次优BPDU，AP收到次级BPDU会变为DP，并发送最优BPDU</p>
</li>
<li><p>BPDU丢包，连续丢3个BPDU，端口角色就需要切换，最长等待6s</p>
</li>
<li><p>任意位置交换机可以发送TC，加快收敛</p>
</li>
</ul>
<p>常见STP&#x2F;RSTP收敛时间如下：</p>
<table>
<thead>
<tr>
<th>IEEE</th>
<th>收敛</th>
<th>CISCO</th>
<th>收敛</th>
</tr>
</thead>
<tbody><tr>
<td>802.1D STP</td>
<td>30-50</td>
<td>PVST&#x2F;PVST+</td>
<td>30-50&#x2F;0-30</td>
</tr>
<tr>
<td>802.1W RAPID-STP</td>
<td>1秒内</td>
<td>RAPID-PVST</td>
<td>1秒内</td>
</tr>
</tbody></table>
<h3 id="RSTP安全防护功能"><a href="#RSTP安全防护功能" class="headerlink" title="RSTP安全防护功能"></a>RSTP安全防护功能</h3><h4 id="BPDU-GUARD"><a href="#BPDU-GUARD" class="headerlink" title="BPDU GUARD"></a>BPDU GUARD</h4><p>BPDU GUARD用于防止意外接受BPDU。配置BPUD防护的edge端口收到BPDU后，会将接口置于errdisable，可以手动down&#x2F;up恢复或配置自动恢复。</p>
<h4 id="BPDU-FILTER"><a href="#BPDU-FILTER" class="headerlink" title="BPDU FILTER"></a>BPDU FILTER</h4><p>BPDU FILTER用于过滤BPDU。同时配置GUARD和FILTER，则先进行FILTER功能。若全局启用BPDU FILTER，则edge端口收到BPDU后会转为生成树端口；若在接口下启用BPDU FILTER，则该接口不收发BPDU。</p>
<h4 id="GUARD-ROOT"><a href="#GUARD-ROOT" class="headerlink" title="GUARD ROOT"></a>GUARD ROOT</h4><p>GUARD ROOT功能可以将端口强制设置位DP，从而防止对端交换机成为根桥。当配置GUARD ROOT的端口收到更高优先级BPDU后，该端口将被置Discarding状态4s，若不再收到跟高级BPDU则恢复为FWD状态。</p>
<h4 id="GUARD-LOOP"><a href="#GUARD-LOOP" class="headerlink" title="GUARD LOOP"></a>GUARD LOOP</h4><p>GUARD LOOP用于防止环路。某些情况，STP中discarding端口错误过渡到FWD状态会出现环路。当RP或AP长时间收不到上游设备的BPDU时，AP会进入Discarding状态并切换为DP；AP会保持在discarding状态，从而不会形成环路。</p>
<h4 id="RSTP安全防护相关配置"><a href="#RSTP安全防护相关配置" class="headerlink" title="RSTP安全防护相关配置"></a>RSTP安全防护相关配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#BPDU GUARD</span><br><span class="line">switch(config)#spanning-tree portfast edge bpdugard default</span><br><span class="line">switch(config-if)#spanning-tree bpduguard enable</span><br><span class="line"></span><br><span class="line">#BPDU FILTER</span><br><span class="line">switch(config)#spanning-tree portfast edge bpdufilter default</span><br><span class="line">switch(config-if)#spanning-tree bpdufilter enable</span><br><span class="line"></span><br><span class="line">#GUARD ROOT</span><br><span class="line">switch(config-if)#spanning-tree guardloop</span><br><span class="line"></span><br><span class="line">#GUARD LOOP</span><br><span class="line">switch(config)#spanning-tree loopguard default </span><br><span class="line">switch(config-if)#spanning-tree guardroot</span><br></pre></td></tr></table></figure>

<h3 id="RSTP兼容性"><a href="#RSTP兼容性" class="headerlink" title="RSTP兼容性"></a>RSTP兼容性</h3><p>RSTP可以兼容STP，当RSTP端口收到三次连续的STP BPDU时，将端口协议切换到STP，但同时会失去RSTP的快速收敛特性。</p>
<h4 id="Rapid-PVST"><a href="#Rapid-PVST" class="headerlink" title="Rapid-PVST+"></a>Rapid-PVST+</h4><p>Rapid-PVST+是Cisco针对RSTP开发的快速收敛版本的PVST+。在每个VLAN中，RPVST+各项特性与RSTP基本一致。</p>
<p>Rapid PVST+配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">switch(config)#spanning-tree mode rapid-pvst </span><br></pre></td></tr></table></figure>

<h2 id="IEEE802-1s-MST"><a href="#IEEE802-1s-MST" class="headerlink" title="IEEE802.1s MST"></a>IEEE802.1s MST</h2><p>IEEE802.1s在RSTP基础上进行了改进，指定了MST，Multiple Spanning Tree多生成树协议，由于STP,RSTP在域内只有一颗树，存在次优路径和贷款浪费的问题。虽然Rapid PVST+解决了这些问题，但Rapid PVST+ 带来新的问题，就是当VLAN数量增多时，每个VLAN都要计算生成树，可能很多VLAN的拓扑可能是一致的，但还是要分开计算生成树，这对交换机造成很大负载压力。</p>
<h3 id="MST的改进"><a href="#MST的改进" class="headerlink" title="MST的改进"></a>MST的改进</h3><p>IEEE802.1s MST解决这个问题，MST的主要特点是支持将VLAN分组定义到不同的多生成树实例MSTI，既满足了不同VLAN不同拓扑的问题，也能将同拓扑VLAN归为一类计算同一生成树，解决交换机负载问题。可以看作是RSTP和RPVST+折中方案。</p>
<h3 id="MIST"><a href="#MIST" class="headerlink" title="MIST"></a>MIST</h3><p>思科也曾尝试开发类似的生成树协议，叫MIST，Multiple Instance Spanning Tree多实例生成树，由于功能基本域MST类似，为了避免小特性上的不同，思科弃用MIST，改用MST。所以现在思科的交换设备上的STP协议通常只有三种：PVST+，Rapid-PVST+,MST。分别对应IEEE802.1D STP，IEEE802.1w RSTP和IEEE802.1s MST。</p>
<h3 id="MST相关概念"><a href="#MST相关概念" class="headerlink" title="MST相关概念"></a>MST相关概念</h3><h4 id="MST-Region"><a href="#MST-Region" class="headerlink" title="MST Region"></a>MST Region</h4><p>MST区域是指具有相同配置一类MST，这些配置包括：</p>
<ul>
<li><p>区域名</p>
</li>
<li><p>相同的实例与vlan映射配置</p>
</li>
<li><p>相同的修订号</p>
</li>
</ul>
<h4 id="MSTI"><a href="#MSTI" class="headerlink" title="MSTI"></a>MSTI</h4><p>MSTI，MST Instance，多生成树实例。一个MSTI可以包含多个vlan的映射。每个MSTI单独使用RSTP计算生成树互不影响。</p>
<h4 id="CST"><a href="#CST" class="headerlink" title="CST"></a>CST</h4><p>CST，Common Spanning Tree，公共生成树，是连接各MSTP区域的一颗生成树。</p>
<h4 id="IST"><a href="#IST" class="headerlink" title="IST"></a>IST</h4><p>IST，Internal Spanning Tree，内部生成树，是指各MST域内的一颗生成树（MSTI0）。</p>
<h4 id="CIST"><a href="#CIST" class="headerlink" title="CIST"></a>CIST</h4><p>CIST，Common and Internal Spanning Tree，公共和内部生成树，是连接二层网络所有交换机的一颗总生成树。</p>
<h4 id="域根"><a href="#域根" class="headerlink" title="域根"></a>域根</h4><p>域根是指MST区域内各MSTI的根（IST根）。</p>
<h4 id="总根"><a href="#总根" class="headerlink" title="总根"></a>总根</h4><p>总根是CIST的根。</p>
<h3 id="MST端口角色"><a href="#MST端口角色" class="headerlink" title="MST端口角色"></a>MST端口角色</h3><p>MSTP保留了RSTP中的RP，DP，AP，BP，EP的概念，新增Master端口MP和域边缘端口Boundary port（BdP）。</p>
<h4 id="Master端口MP"><a href="#Master端口MP" class="headerlink" title="Master端口MP"></a>Master端口MP</h4><p>Master端口是MST域和总跟相连路径中最短路径的端口，MP是特殊的BdP</p>
<h4 id="域边缘端口BdP"><a href="#域边缘端口BdP" class="headerlink" title="域边缘端口BdP"></a>域边缘端口BdP</h4><p>域边缘端口BdP是位于MST域边缘并连接其它STP域的端口</p>
<p>MST端口角色示意图如下：</p>
<p><img src="/2022/05/08/switch-basic2/mst_port.png" alt="SWITCH MST_PORT"></p>
<h3 id="MST端口状态"><a href="#MST端口状态" class="headerlink" title="MST端口状态"></a>MST端口状态</h3><p>MST端口状态与RSTP完全相同，分别为Forwarding，Learning和Discarding</p>
<h3 id="MST-BPDU格式"><a href="#MST-BPDU格式" class="headerlink" title="MST BPDU格式"></a>MST BPDU格式</h3><p>相比较于RSTP，MSTP BPDU增加了version3长度和MST配置信息的一些字段，抓包如下</p>
<p><img src="/2022/05/08/switch-basic2/mst_bpdu.png" alt="SWITCH MST_BPDU"></p>
<p>其中</p>
<p>MST conifg name：MST区域名</p>
<p>MST config revision：MST修订号</p>
<p>CIST Internal Root Path Cost：CIST内部路径开销，从本端口到IST Master累计路径开销。</p>
<p>CIST BID：CIST指定交换机BID</p>
<p>CIST Remaining Hops：BPDU在CIST剩余跳数</p>
<p>MSTID x：MSTI配置信息</p>
<h3 id="MST收敛"><a href="#MST收敛" class="headerlink" title="MST收敛"></a>MST收敛</h3><p>MST将二层网络划分为多个MST域，MST域间计算生成CST，域内分别计算MSTI。各交换机通过MST BPDU来生成MSTI和CIST</p>
<h4 id="CIST拓扑计算"><a href="#CIST拓扑计算" class="headerlink" title="CIST拓扑计算"></a>CIST拓扑计算</h4><p>经处理BPDU消息，整个二层网络BID最小的设备成为CIST总根。每隔MST域内计算生成IST(MST0)，同时MST将各MST域作为整体在MST域间计算CST。CST和IST构成CIST。</p>
<h5 id="CIST总根选举"><a href="#CIST总根选举" class="headerlink" title="CIST总根选举"></a>CIST总根选举</h5><p>CIST根据以下原则在域根桥中选总根（越小越优）：</p>
<p>1、域根BID</p>
<p>2、外部路径开销</p>
<p>3、内部路径开销</p>
<p>4、指定交换机BID</p>
<p>5、指定端口PID</p>
<p>6、接受端口PID</p>
<h5 id="CIST端口角色选举（RP-x2F-DP-x2F-MP）"><a href="#CIST端口角色选举（RP-x2F-DP-x2F-MP）" class="headerlink" title="CIST端口角色选举（RP&#x2F;DP&#x2F;MP）"></a>CIST端口角色选举（RP&#x2F;DP&#x2F;MP）</h5><p>CIST根据以下原则选举端口角色（越小越优）：</p>
<p>1、CIST总根BID</p>
<p>2、CIST到总根的外部开销</p>
<p>3、CIST域根BID</p>
<p>4、CIST到域根的内部开销</p>
<p>5、CIST BPDU发送端BID</p>
<p>6、CIST BPDU发送端PID</p>
<p>7、CIST BPDU接收端PID</p>
<h4 id="MSTI拓扑计算"><a href="#MSTI拓扑计算" class="headerlink" title="MSTI拓扑计算"></a>MSTI拓扑计算</h4><p>MST域内，各MSTI根据VLAN映射关系分别计算生成树，计算方法与RSTP类似。在MST域内安装MSTI转发数据，MST域间按照CST转发数据。</p>
<h4 id="MST拓扑变化与快速收敛机制"><a href="#MST拓扑变化与快速收敛机制" class="headerlink" title="MST拓扑变化与快速收敛机制"></a>MST拓扑变化与快速收敛机制</h4><p>MSTP拓扑变化与快速收敛机制与RSTP类似。</p>
<h3 id="MST兼容性"><a href="#MST兼容性" class="headerlink" title="MST兼容性"></a>MST兼容性</h3><p>MSTI0可与RSTP&#x2F;STP兼容，不能与PVST+&#x2F;RPVST+兼容，相应互联端口会置BKN*状态。</p>
<h3 id="MST配置"><a href="#MST配置" class="headerlink" title="MST配置"></a>MST配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#进入mst配置</span><br><span class="line">swtich(config)#spanning-tree mst configuration </span><br><span class="line"></span><br><span class="line">#配置mst区域信息，name，revision，MSTI vlan映射</span><br><span class="line">swtich(config-mst)#name ccie</span><br><span class="line">swtich(config-mst)#revision 100</span><br><span class="line">swtich(config-mst)#instance 1 vlan 2-19</span><br><span class="line">swtich(config-mst)#instance 2 vlan 20-100</span><br><span class="line"></span><br><span class="line">#配置msti优先级</span><br><span class="line">switch(config)#spanning-tree mst 1 priority 8192</span><br></pre></td></tr></table></figure>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://arclogicr.github.io/2022/05/08/switch-basic2/" title="交换基础2-STP" target="_blank" rel="external">https://arclogicr.github.io/2022/05/08/switch-basic2/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/arclogicr" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/arclogicr" target="_blank"><span class="text-dark">Arclogic</span><small class="ml-1x">网络工程师</small></a></h3>
        <div>大勇若怯，大智若愚</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/12/09/pushgateway/" title="使用pushgateway监控需要上传文件的应用接口"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2022/04/25/switch-basic/" title="交换基础1"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
    <div class="copyright">
    	
        &copy; 2024 Arclogic
        
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     





    <script async src="https://www.googletagmanager.com/gtag/js?id=G-55WVJ2X9MK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-55WVJ2X9MK');
</script>




</body>
</html>